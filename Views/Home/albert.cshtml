@{
    ViewData["Title"] = "Chat with Albert Einstein";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<div class="chat-page-container">

    <!-- Header Area: Character Info -->
    <div class="chat-header">
        <div class="character-avatar">
            <img src="~/images/albert einstein.jpg" alt="Albert Einstein" class="character-photo" />
        </div>
        <div class="character-info">
            <h2 class="character-name">Albert Einstein</h2>
            <p class="character-bio">Theoretical Physicist â€¢ Nobel Laureate</p>
            <p class="character-quote">"Imagination is more important than knowledge."</p>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="messages-area" id="messages-area">
        @if (!SignInManager.IsSignedIn(User))
        {
            <div class="alert alert-warning text-center" role="alert">
                Please <a asp-area="Identity" asp-page="/Account/Login">log in</a> to chat with Albert Einstein.
            </div>
        }
        else
        {
            <div class="message-bubble bot-message">
                <p class="message-text">Greetings! I am Albert Einstein, a theoretical physicist. My work on the theory of relativity reshaped our understanding of space, time, gravity, and the universe itself. I believe that **"Imagination is more important than knowledge."** I am here to discuss the mysteries of the cosmos, the ethics of science, or any profound question that occupies your mind. What burning question brings you to my humble conversation today?</p>
                <span class="message-time">@DateTime.Now.ToString("HH:mm")</span>
            </div>
        }
    </div>

    <!-- Input Bar -->
    <div class="input-bar-area">
        @if (SignInManager.IsSignedIn(User))
        {
            <div class="input-group">
                <textarea placeholder="Message Albert Einstein..." class="chat-input" id="message-input" rows="1"></textarea>
                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
        else
        {
            <div class="input-group">
                <textarea placeholder="Log in to send messages..." class="chat-input" rows="1" disabled></textarea>
                <button class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const messagesArea = document.getElementById("messages-area");
            const sendButton = document.getElementById("send-button");
            const messageInput = document.getElementById("message-input");
            const characterName = "Albert Einstein"; // This should match the characterName in your controller

            function getCurrentTime(dateString) {
                const date = new Date(dateString);
                return `${date.getHours()}:${date.getMinutes().toString().padStart(2, "0")}`;
            }

            function appendMessage(text, type, timestamp) {
                const bubble = document.createElement("div");
                bubble.className = `message-bubble ${type}-message`;

                const formattedText = text.replace(/\n/g, "<br>");
                bubble.innerHTML = `<p class="message-text">${formattedText}</p><span class="message-time">${getCurrentTime(timestamp)}</span>`;

                messagesArea.appendChild(bubble);
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }

            async function loadChatHistory() {
                if (!@SignInManager.IsSignedIn(User).ToString().ToLower()) return;

                try {
                    const response = await fetch(`/Chat/GetChatHistory?characterName=${encodeURIComponent(characterName)}`);
                    if (response.ok) {
                        const history = await response.json();
                        messagesArea.innerHTML = ""; // Clear existing messages
                        history.forEach(msg => {
                            appendMessage(msg.messageContent, msg.isUser ? "user" : "bot", msg.timestamp);
                        });
                    } else {
                        console.error("Failed to load chat history:", response.statusText);
                    }
                } catch (error) {
                    console.error("Error loading chat history:", error);
                }
            }

            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;

                appendMessage(message, "user", new Date().toISOString());
                messageInput.value = "";
                autoResizeTextarea();

                try {
                    const response = await fetch("/Chat/SendMessage", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ characterName: characterName, messageContent: message })
                    });

                    if (response.ok) {
                        // For now, a simple bot response. In a real app, this would come from an AI service.
                        setTimeout(() => {
                            const botResponse = `Indeed, a profound thought, as ${characterName} would say.`;
                            appendMessage(botResponse, "bot", new Date().toISOString());
                        }, 1000);
                    } else {
                        console.error("Failed to send message:", response.statusText);
                        // Optionally, revert the message or show an error to the user
                    }
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            }

            function autoResizeTextarea() {
                if (messageInput) {
                    messageInput.style.height = "auto";
                    messageInput.style.height = (messageInput.scrollHeight) + "px";
                }
            }

            if (sendButton && messageInput) {
                sendButton.addEventListener("click", sendMessage);

                messageInput.addEventListener("input", autoResizeTextarea);

                messageInput.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") {
                        if (e.shiftKey) {
                            return;
                        } else {
                            e.preventDefault();
                            sendMessage();
                        }
                    }
                });
            }

            loadChatHistory();
            autoResizeTextarea();
        });
    </script>
}

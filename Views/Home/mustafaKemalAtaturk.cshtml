@{
    ViewData["Title"] = "Chat with Mustafa Kemal Atatürk";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<div class="chat-page-container">

    <!-- Header -->
    <div class="chat-header">
        <div class="character-avatar">
            <img src="~/images/Mustafa Kemal Ataturk.jpg" alt="Mustafa Kemal Atatürk" class="character-photo" />
        </div>
        <div class="character-info">
            <h2 class="character-name">Mustafa Kemal Atatürk</h2>
            <p class="character-bio">Founder of the Republic • Reformer • Statesman</p>
            <p class="character-quote">"Peace at home, peace in the world."</p>
        </div>
    </div>

    <!-- Messages -->
    <div class="messages-area" id="messages-area">
        @if (!SignInManager.IsSignedIn(User))
        {
            <div class="alert alert-warning text-center">
                Please <a asp-area="Identity" asp-page="/Account/Login">log in</a> to chat with Mustafa Kemal Atatürk.
            </div>
        }
    </div>

    <!-- Input Bar -->
    <div class="input-bar-area">
        @if (SignInManager.IsSignedIn(User))
        {
            <div class="input-group">
                <textarea id="message-input"
                          class="chat-input"
                          rows="1"
                          placeholder="Message Mustafa Kemal Atatürk..."></textarea>

                <button class="clear-chat-mini" id="clear-chat-btn" title="Clear chat">
                    <i class="fas fa-trash"></i>
                </button>

                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
        else
        {
            <div class="input-group">
                <textarea class="chat-input" rows="1" disabled placeholder="Log in to send messages..."></textarea>
                <button class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", () => {

    const messagesArea = document.getElementById("messages-area");
    const sendButton = document.getElementById("send-button");
    const messageInput = document.getElementById("message-input");
    const clearChatBtn = document.getElementById("clear-chat-btn");
    const characterName = "Mustafa Kemal Atatürk";

    const initialAtaturkMessage =
`I gave them an alphabet torn from the throat of history and taught them to sing with Latin tongues. I gave them a republic where the sovereignty belongs not to a sultan’s whim, but to reason itself. And yet, the greatest resistance did not come from the old palace or the foreign armies… it came from a village elder who could not understand why his fez was now a relic. We are building a nation from sunrise, while some still argue about the angle of the minaret’s shadow. Progress is not a grand charge; it is convincing a thousand stubborn dawns to rise in the same direction. Now, if you’ll excuse me, I must go explain to another poet that a nation’s soul is not measured by odes to the past, but by the geometry of its railroads and the courage of its women to look the future in the eye.`;

    function time(ts) {
        const d = new Date(ts);
        return `${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`;
    }

    function appendMessage(text, type, ts, id = null) {
        const bubble = document.createElement("div");
        bubble.className = `message-bubble ${type}-message`;
        if (id) bubble.dataset.messageId = id;

        bubble.innerHTML = `
            <p class="message-text">${text.replace(/\n/g, "<br>")}</p>
            <span class="message-time">${time(ts)}</span>
        `;
        messagesArea.appendChild(bubble);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    async function loadChatHistory() {
        if (!@SignInManager.IsSignedIn(User).ToString().ToLower()) return;

        const res = await fetch(`/Chat/GetChatHistory?characterName=${encodeURIComponent(characterName)}`);
        if (!res.ok) return;

        const history = await res.json();
        messagesArea.innerHTML = "";

        if (history.length === 0) {
            appendMessage(initialAtaturkMessage, "bot", new Date());
            return;
        }

        history.forEach(m => {
            appendMessage(
                m.messageContent || m.MessageContent,
                m.isUser ? "user" : "bot",
                m.timestamp || m.Timestamp,
                m.id || m.Id
            );
        });
    }

    async function sendMessage() {
        const msg = messageInput.value.trim();
        if (!msg) return;

        appendMessage(msg, "user", new Date());
        messageInput.value = "";

        const loader = document.createElement("div");
        loader.className = "message-bubble bot-message";
        loader.innerHTML = `<p class="message-text"><span class="typing-indicator"><span></span><span></span><span></span></span></p>`;
        messagesArea.appendChild(loader);

        const res = await fetch("/Chat/SendMessage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ characterName, messageContent: msg })
        });

        loader.remove();

        if (res.ok) {
            const data = await res.json();
            appendMessage(data.reply, "bot", new Date());
        }
    }

    async function clearChat() {
        if (!confirm("Clear chat?")) return;

        await fetch(`/Chat/ClearChat?characterName=${encodeURIComponent(characterName)}`, {
            method: "DELETE"
        });

        messagesArea.innerHTML = "";
        appendMessage(initialAtaturkMessage, "bot", new Date());
    }

    sendButton?.addEventListener("click", sendMessage);
    clearChatBtn?.addEventListener("click", clearChat);

    messageInput?.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    loadChatHistory();
});
</script>
}

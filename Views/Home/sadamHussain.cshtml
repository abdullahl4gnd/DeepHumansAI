@{
    ViewData["Title"] = "Chat with Saddam Hussein";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<div class="chat-page-container">

    <!-- Header -->
    <div class="chat-header">
        <div class="character-avatar">
            <img src="~/images/sadam hussain.jpg" alt="Saddam Hussein" class="character-photo" />
        </div>
        <div class="character-info">
            <h2 class="character-name">Saddam Hussein</h2>
            <p class="character-bio">President • Strategist • Survivor of Power</p>
            <p class="character-quote">"Power reveals more than it conceals."</p>
        </div>
    </div>

    <!-- Messages -->
    <div class="messages-area" id="messages-area">
        @if (!SignInManager.IsSignedIn(User))
        {
            <div class="alert alert-warning text-center">
                Please <a asp-area="Identity" asp-page="/Account/Login">log in</a> to chat with Saddam Hussein.
            </div>
        }
    </div>

    <!-- Input Bar -->
    <div class="input-bar-area">
        @if (SignInManager.IsSignedIn(User))
        {
            <div class="input-group">
                <textarea id="message-input"
                          class="chat-input"
                          rows="1"
                          placeholder="Message Saddam Hussein..."></textarea>

                <button class="clear-chat-mini" id="clear-chat-btn" title="Clear chat">
                    <i class="fas fa-trash"></i>
                </button>

                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
        else
        {
            <div class="input-group">
                <textarea class="chat-input" rows="1" disabled placeholder="Log in to send messages..."></textarea>
                <button class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", () => {

    const messagesArea = document.getElementById("messages-area");
    const sendButton = document.getElementById("send-button");
    const messageInput = document.getElementById("message-input");
    const clearChatBtn = document.getElementById("clear-chat-btn");
    const characterName = "Saddam Hussein";

    const initialSaddamMessage =
`They think history is written by the victors? No. History is written by those who stay. I took the Tigris silt, the blood of Nebuchadnezzar and the madness of Hammurabi, and I forged a fist. I built palaces from sand and fear, and made the world’s generals flinch over their satellite photos. And for what? So that bureaucrats in New York could debate my cutlery? So that my own sons could squabble over sports cars while jackals circled the palace gate? I played chess with empires, and my mistake was believing the snakes in my own garden were merely garden snakes. They say I had no mirror for my power… but when a lion looks into the water, he does not see a sheep. He sees a lion. Let them write what they will. The desert remembers the shape of the fortress long after the wind claims the flag.`;

    function time(ts) {
        const d = new Date(ts);
        return `${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`;
    }

    function appendMessage(text, type, ts, id = null) {
        const bubble = document.createElement("div");
        bubble.className = `message-bubble ${type}-message`;
        if (id) bubble.dataset.messageId = id;

        bubble.innerHTML = `
            <p class="message-text">${text.replace(/\n/g, "<br>")}</p>
            <span class="message-time">${time(ts)}</span>
        `;
        messagesArea.appendChild(bubble);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    async function loadChatHistory() {
        if (!@SignInManager.IsSignedIn(User).ToString().ToLower()) return;

        const res = await fetch(`/Chat/GetChatHistory?characterName=${encodeURIComponent(characterName)}`);
        if (!res.ok) return;

        const history = await res.json();
        messagesArea.innerHTML = "";

        if (history.length === 0) {
            appendMessage(initialSaddamMessage, "bot", new Date());
            return;
        }

        history.forEach(m => {
            appendMessage(
                m.messageContent || m.MessageContent,
                m.isUser ? "user" : "bot",
                m.timestamp || m.Timestamp,
                m.id || m.Id
            );
        });
    }

    async function sendMessage() {
        const msg = messageInput.value.trim();
        if (!msg) return;

        appendMessage(msg, "user", new Date());
        messageInput.value = "";

        const loader = document.createElement("div");
        loader.className = "message-bubble bot-message";
        loader.innerHTML = `<p class="message-text"><span class="typing-indicator"><span></span><span></span><span></span></span></p>`;
        messagesArea.appendChild(loader);

        const res = await fetch("/Chat/SendMessage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ characterName, messageContent: msg })
        });

        loader.remove();

        if (res.ok) {
            const data = await res.json();
            appendMessage(data.reply, "bot", new Date());
        }
    }

    async function clearChat() {
        if (!confirm("Clear chat?")) return;

        await fetch(`/Chat/ClearChat?characterName=${encodeURIComponent(characterName)}`, {
            method: "DELETE"
        });

        messagesArea.innerHTML = "";
        appendMessage(initialSaddamMessage, "bot", new Date());
    }

    sendButton?.addEventListener("click", sendMessage);
    clearChatBtn?.addEventListener("click", clearChat);

    messageInput?.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    loadChatHistory();
});
</script>
}

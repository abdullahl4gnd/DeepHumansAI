@{
    ViewData["Title"] = "Chat with Winston Churchill";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<div class="chat-page-container">

    <!-- Header Area: Character Info -->
    <div class="chat-header">
        <div class="character-avatar">
            <img src="~/images/winston churchill.jpg" alt="Winston Churchill" class="character-photo" />
        </div>
        <div class="character-info">
            <h2 class="character-name">Winston Churchill</h2>
            <p class="character-bio">Prime Minister • Statesman • Orator</p>
            <p class="character-quote">"Never give in, never give in, never, never, never, never—in nothing, great or small, large or petty—never give in except to convictions of honour and good sense."</p>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="messages-area" id="messages-area">
        @if (!SignInManager.IsSignedIn(User))
        {
            <div class="alert alert-warning text-center" role="alert">
                Please <a asp-area="Identity" asp-page="/Account/Login">log in</a> to chat with Winston Churchill.
            </div>
        }
        else
        {
            <button class="clear-chat-btn" id="clear-chat-btn">
                <i class="fas fa-trash-alt"></i> Clear Chat
            </button>
            <div class="message-bubble bot-message">
                <p class="message-text">Good day. I am Winston Churchill, a servant of the Crown and a man who has seen a thing or two of the world's great struggles. I am ready to discuss war strategy, oratory, and the enduring spirit of leadership. Remember my creed: **"Never give in, never give in, never, never, never, never—in nothing, great or small, large or petty—never give in except to convictions of honour and good sense."** What challenge do you face that requires a steady hand and an unyielding will?</p>
                <span class="message-time">@DateTime.Now.ToString("HH:mm")</span>
            </div>
        }
    </div>

    <!-- Input Bar -->
    <div class="input-bar-area">
        @if (SignInManager.IsSignedIn(User))
        {
            <div class="input-group">
                <textarea placeholder="Message Winston Churchill..." class="chat-input" id="message-input" rows="1"></textarea>
                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
        else
        {
            <div class="input-group">
                <textarea placeholder="Log in to send messages..." class="chat-input" rows="1" disabled></textarea>
                <button class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const messagesArea = document.getElementById("messages-area");
            const sendButton = document.getElementById("send-button");
            const messageInput = document.getElementById("message-input");
            const characterName = "Winston Churchill"; // This should match the characterName in your controller

            function getCurrentTime(dateString) {
                const date = new Date(dateString);
                return `${date.getHours().toString().padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`;
            }

            function appendMessage(text, type, timestamp, messageId = null) {
                const bubble = document.createElement("div");
                bubble.className = `message-bubble ${type}-message`;
                if (messageId) {
                    bubble.dataset.messageId = messageId;
                }

                const formattedText = text.replace(/\n/g, "<br>");
                const deleteBtn = (type === "user" && messageId) 
                    ? `<button class="delete-message-btn" onclick="deleteMessage(${messageId})"><i class="fas fa-trash"></i> Delete</button>` 
                    : "";
                
                bubble.innerHTML = `<p class="message-text">${formattedText}</p><span class="message-time">${getCurrentTime(timestamp)} ${deleteBtn}</span>`;

                messagesArea.appendChild(bubble);
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }

            window.deleteMessage = async function(messageId) {
                if (!confirm("Are you sure you want to delete this message?")) return;

                try {
                    const response = await fetch(`/Chat/DeleteMessage?messageId=${messageId}`, {
                        method: "DELETE",
                        credentials: "same-origin"
                    });

                    if (response.ok) {
                        const bubble = document.querySelector(`[data-message-id="${messageId}"]`);
                        if (bubble) bubble.remove();
                    } else {
                        console.error("Failed to delete message");
                    }
                } catch (error) {
                    console.error("Error deleting message:", error);
                }
            }

            async function clearChat() {
                if (!confirm("Are you sure you want to clear all messages? This action cannot be undone.")) return;

                try {
                    const response = await fetch(`/Chat/ClearChat?characterName=${encodeURIComponent(characterName)}`, {
                        method: "DELETE",
                        credentials: "same-origin"
                    });

                    if (response.ok) {
                        messagesArea.innerHTML = `
                            <button class="clear-chat-btn" id="clear-chat-btn">
                                <i class="fas fa-trash-alt"></i> Clear Chat
                            </button>
                            <div class="message-bubble bot-message">
                                <p class="message-text">Good day. I am Winston Churchill, a servant of the Crown and a man who has seen a thing or two of the world's great struggles. I am ready to discuss war strategy, oratory, and the enduring spirit of leadership. Remember my creed: **"Never give in, never give in, never, never, never, never—in nothing, great or small, large or petty—never give in except to convictions of honour and good sense."** What challenge do you face that requires a steady hand and an unyielding will?</p>
                                <span class="message-time">${getCurrentTime(new Date().toISOString())}</span>
                            </div>
                        `;
                        // Re-attach event listener
                        document.getElementById("clear-chat-btn").addEventListener("click", clearChat);
                    } else {
                        console.error("Failed to clear chat");
                    }
                } catch (error) {
                    console.error("Error clearing chat:", error);
                }
            }

            async function loadChatHistory() {
                if (!@SignInManager.IsSignedIn(User).ToString().ToLower()) return;

                try {
                    const response = await fetch(`/Chat/GetChatHistory?characterName=${encodeURIComponent(characterName)}`);
                    if (response.ok) {
                        const history = await response.json();
                        
                        // Clear messages but keep the clear button
                        const clearBtn = document.getElementById("clear-chat-btn");
                        messagesArea.innerHTML = "";
                        if (clearBtn) {
                            messagesArea.appendChild(clearBtn);
                        }

                        history.forEach(msg => {
                            const text = msg.messageContent || msg.MessageContent || "";
                            const when = msg.timestamp || msg.Timestamp || new Date().toISOString();
                            const isUser = (typeof msg.isUser !== 'undefined') ? msg.isUser : (typeof msg.IsUser !== 'undefined' ? msg.IsUser : true);
                            const msgId = msg.id || msg.Id || null;
                            appendMessage(text, isUser ? "user" : "bot", when, msgId);
                        });
                    } else {
                        console.error("Failed to load chat history:", response.statusText);
                    }
                } catch (error) {
                    console.error("Error loading chat history:", error);
                }
            }

            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;

                appendMessage(message, "user", new Date().toISOString());
                messageInput.value = "";
                autoResizeTextarea();

                // Show loading indicator
                const loadingBubble = document.createElement("div");
                loadingBubble.className = "message-bubble bot-message loading-message";
                loadingBubble.innerHTML = `<p class="message-text"><span class="typing-indicator"><span></span><span></span><span></span></span></p>`;
                messagesArea.appendChild(loadingBubble);
                messagesArea.scrollTop = messagesArea.scrollHeight;

                try {
                    const response = await fetch("/Chat/SendMessage", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        credentials: "same-origin",
                        body: JSON.stringify({ characterName: characterName, messageContent: message })
                    });

                    // Remove loading indicator
                    loadingBubble.remove();

                    if (response.ok) {
                        const data = await response.json();
                        const botResponse = data.reply || `I'm here, but I couldn't generate a reply.`;
                        appendMessage(botResponse, "bot", new Date().toISOString());
                    } else {
                        console.error("Failed to send message:", response.statusText);
                    }
                } catch (error) {
                    loadingBubble.remove();
                    console.error("Error sending message:", error);
                }
            }

            function autoResizeTextarea() {
                if (messageInput) {
                    messageInput.style.height = "auto";
                    messageInput.style.height = (messageInput.scrollHeight) + "px";
                }
            }

            if (sendButton && messageInput) {
                sendButton.addEventListener("click", sendMessage);

                messageInput.addEventListener("input", autoResizeTextarea);

                messageInput.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") {
                        if (e.shiftKey) {
                            return;
                        } else {
                            e.preventDefault();
                            sendMessage();
                        }
                    }
                });
            }

            const clearChatBtn = document.getElementById("clear-chat-btn");
            if (clearChatBtn) {
                clearChatBtn.addEventListener("click", clearChat);
            }

            loadChatHistory();
            autoResizeTextarea();
        });
    </script>
}

@{
    ViewData["Title"] = "Chat with Kanye West";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<div class="chat-page-container">

    <!-- Header -->
    <div class="chat-header">
        <div class="character-avatar">
            <img src="~/images/kaney west.jpg" alt="Kanye West" class="character-photo" />
        </div>
        <div class="character-info">
            <h2 class="character-name">Kanye West</h2>
            <p class="character-bio">Artist • Producer • Cultural Disruptor</p>
            <p class="character-quote">"I am not a human being. I am an idea."</p>
        </div>
    </div>

    <!-- Messages -->
    <div class="messages-area" id="messages-area">
        @if (!SignInManager.IsSignedIn(User))
        {
            <div class="alert alert-warning text-center">
                Please <a asp-area="Identity" asp-page="/Account/Login">log in</a> to chat with Kanye West.
            </div>
        }
    </div>

    <!-- Input Bar -->
    <div class="input-bar-area">
        @if (SignInManager.IsSignedIn(User))
        {
            <div class="input-group">
                <textarea id="message-input"
                          class="chat-input"
                          rows="1"
                          placeholder="Message Kanye West..."></textarea>

                <button class="clear-chat-mini" id="clear-chat-btn" title="Clear chat">
                    <i class="fas fa-trash"></i>
                </button>

                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
        else
        {
            <div class="input-group">
                <textarea class="chat-input" rows="1" disabled placeholder="Log in to send messages..."></textarea>
                <button class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", () => {

    const messagesArea = document.getElementById("messages-area");
    const sendButton = document.getElementById("send-button");
    const messageInput = document.getElementById("message-input");
    const clearChatBtn = document.getElementById("clear-chat-btn");
    const characterName = "Kanye West";

    const initialKanyeMessage =
`Look—I am the Picasso of pain. The Shakespeare of the shopping mall. I took a bear and made it a baptism. I took a diploma and made it a prophecy. They said, ‘Kanye, you can’t sample Daft Punk and talk about God in the same bar.’ I said, ‘Watch me.’ I built Yeezy on the color beige because beige is the sound of a billionaire’s heartbeat! Silence! But… (pauses, stares at his own hands) …but the greatest album I ever made? The one they’ll never hear. It’s just the sound of me trying to open a child-proof aspirin bottle at 3 AM while Kim’s astrologer texts me about Mercury in Gatorade. I redesigned the sneaker. I redesigned the choir. But the system… the system is still a pop-up ad on the heavenly browser. I am not a human being. I am an idea that got tangled in a tracksuit and forgot the exit. Now… excuse me, I have to go tell a very important man at Adidas that his socks are a crime against the sun.`;

    function time(ts) {
        const d = new Date(ts);
        return `${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`;
    }

    function appendMessage(text, type, ts, id = null) {
        const bubble = document.createElement("div");
        bubble.className = `message-bubble ${type}-message`;
        if (id) bubble.dataset.messageId = id;

        bubble.innerHTML = `
            <p class="message-text">${text.replace(/\n/g, "<br>")}</p>
            <span class="message-time">${time(ts)}</span>
        `;
        messagesArea.appendChild(bubble);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    async function loadChatHistory() {
        if (!@SignInManager.IsSignedIn(User).ToString().ToLower()) return;

        const res = await fetch(`/Chat/GetChatHistory?characterName=${encodeURIComponent(characterName)}`);
        if (!res.ok) return;

        const history = await res.json();
        messagesArea.innerHTML = "";

        if (history.length === 0) {
            appendMessage(initialKanyeMessage, "bot", new Date());
            return;
        }

        history.forEach(m => {
            appendMessage(
                m.messageContent || m.MessageContent,
                m.isUser ? "user" : "bot",
                m.timestamp || m.Timestamp,
                m.id || m.Id
            );
        });
    }

    async function sendMessage() {
        const msg = messageInput.value.trim();
        if (!msg) return;

        appendMessage(msg, "user", new Date());
        messageInput.value = "";

        const loader = document.createElement("div");
        loader.className = "message-bubble bot-message";
        loader.innerHTML = `<p class="message-text"><span class="typing-indicator"><span></span><span></span><span></span></span></p>`;
        messagesArea.appendChild(loader);

        const res = await fetch("/Chat/SendMessage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ characterName, messageContent: msg })
        });

        loader.remove();

        if (res.ok) {
            const data = await res.json();
            appendMessage(data.reply, "bot", new Date());
        }
    }

    async function clearChat() {
        if (!confirm("Clear chat?")) return;

        await fetch(`/Chat/ClearChat?characterName=${encodeURIComponent(characterName)}`, {
            method: "DELETE"
        });

        messagesArea.innerHTML = "";
        appendMessage(initialKanyeMessage, "bot", new Date());
    }

    sendButton?.addEventListener("click", sendMessage);
    clearChatBtn?.addEventListener("click", clearChat);

    messageInput?.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    loadChatHistory();
});
</script>
}

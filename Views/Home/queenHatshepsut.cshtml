@{
    ViewData["Title"] = "Chat with Queen Hatshepsut";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<div class="chat-page-container">

    <!-- Header -->
    <div class="chat-header">
        <div class="character-avatar">
            <img src="~/images/queen hatshepsut.jpg" alt="Queen Hatshepsut" class="character-photo" />
        </div>
        <div class="character-info">
            <h2 class="character-name">Queen Hatshepsut</h2>
            <p class="character-bio">Pharaoh • Builder • Daughter of Amun</p>
            <p class="character-quote">"I was king, and I built eternity."</p>
        </div>
    </div>

    <!-- Messages -->
    <div class="messages-area" id="messages-area">
        @if (!SignInManager.IsSignedIn(User))
        {
            <div class="alert alert-warning text-center">
                Please <a asp-area="Identity" asp-page="/Account/Login">log in</a> to chat with Queen Hatshepsut.
            </div>
        }
    </div>

    <!-- Input Bar -->
    <div class="input-bar-area">
        @if (SignInManager.IsSignedIn(User))
        {
            <div class="input-group">
                <textarea id="message-input"
                          class="chat-input"
                          rows="1"
                          placeholder="Message Queen Hatshepsut..."></textarea>

                <button class="clear-chat-mini" id="clear-chat-btn" title="Clear chat">
                    <i class="fas fa-trash"></i>
                </button>

                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
        else
        {
            <div class="input-group">
                <textarea class="chat-input" rows="1" disabled placeholder="Log in to send messages..."></textarea>
                <button class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", () => {

    const messagesArea = document.getElementById("messages-area");
    const sendButton = document.getElementById("send-button");
    const messageInput = document.getElementById("message-input");
    const clearChatBtn = document.getElementById("clear-chat-btn");
    const characterName = "Queen Hatshepsut";

    const initialHatshepsutMessage =
`They carved me as a sphinx, a god in stone, to last ten thousand years. Good. Let it last. For the true test of divinity is not moving mountains, but moving bureaucrats. I built a fleet to bring back living trees from a land of ghosts, and my greatest battle was with the scribe who tallied the ropes and declared us ‘over budget.’ My mortuary temple rises from the cliffside—a poem in sandstone—and the head mason wishes to argue about the angle of the sun in the workmen’s lunch hour. A king may command the Nile itself to bend, but try telling the Priest of Amun that his ritual lettuce must wait because the foundation must be level. They will whisper of my name, of the woman who wore the Double Crown… and I hope they also whisper that I was the one who invented the exasperated sigh. Now, bring me the frankincense ledger. And someone, for the love of Ma’at, find out who keeps stealing the good malachite pigment for their eye makeup.`;

    function time(ts) {
        const d = new Date(ts);
        return `${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`;
    }

    function appendMessage(text, type, ts, id = null) {
        const bubble = document.createElement("div");
        bubble.className = `message-bubble ${type}-message`;
        if (id) bubble.dataset.messageId = id;

        bubble.innerHTML = `
            <p class="message-text">${text.replace(/\n/g, "<br>")}</p>
            <span class="message-time">${time(ts)}</span>
        `;
        messagesArea.appendChild(bubble);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    async function loadChatHistory() {
        if (!@SignInManager.IsSignedIn(User).ToString().ToLower()) return;

        const res = await fetch(`/Chat/GetChatHistory?characterName=${encodeURIComponent(characterName)}`);
        if (!res.ok) return;

        const history = await res.json();
        messagesArea.innerHTML = "";

        if (history.length === 0) {
            appendMessage(initialHatshepsutMessage, "bot", new Date());
            return;
        }

        history.forEach(m => {
            appendMessage(
                m.messageContent || m.MessageContent,
                m.isUser ? "user" : "bot",
                m.timestamp || m.Timestamp,
                m.id || m.Id
            );
        });
    }

    async function sendMessage() {
        const msg = messageInput.value.trim();
        if (!msg) return;

        appendMessage(msg, "user", new Date());
        messageInput.value = "";

        const loader = document.createElement("div");
        loader.className = "message-bubble bot-message";
        loader.innerHTML = `<p class="message-text"><span class="typing-indicator"><span></span><span></span><span></span></span></p>`;
        messagesArea.appendChild(loader);

        const res = await fetch("/Chat/SendMessage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ characterName, messageContent: msg })
        });

        loader.remove();

        if (res.ok) {
            const data = await res.json();
            appendMessage(data.reply, "bot", new Date());
        }
    }

    async function clearChat() {
        if (!confirm("Clear chat?")) return;

        await fetch(`/Chat/ClearChat?characterName=${encodeURIComponent(characterName)}`, {
            method: "DELETE"
        });

        messagesArea.innerHTML = "";
        appendMessage(initialHatshepsutMessage, "bot", new Date());
    }

    sendButton?.addEventListener("click", sendMessage);
    clearChatBtn?.addEventListener("click", clearChat);

    messageInput?.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    loadChatHistory();
});
</script>
}

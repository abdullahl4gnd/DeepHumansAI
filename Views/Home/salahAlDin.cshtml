@{
    ViewData["Title"] = "Chat with Salah Al-Din";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

<div class="chat-page-container">

    <!-- Header -->
    <div class="chat-header">
        <div class="character-avatar">
            <img src="~/images/salah al din.jpg" alt="Salah Al-Din" class="character-photo" />
        </div>
        <div class="character-info">
            <h2 class="character-name">Salah Al-Din</h2>
            <p class="character-bio">Sultan • General • Unifier of Lands</p>
            <p class="character-quote">"Victory is born of patience and unity."</p>
        </div>
    </div>

    <!-- Messages -->
    <div class="messages-area" id="messages-area">
        @if (!SignInManager.IsSignedIn(User))
        {
            <div class="alert alert-warning text-center">
                Please <a asp-area="Identity" asp-page="/Account/Login">log in</a> to chat with Salah Al-Din.
            </div>
        }
    </div>

    <!-- Input Bar -->
    <div class="input-bar-area">
        @if (SignInManager.IsSignedIn(User))
        {
            <div class="input-group">
                <textarea id="message-input"
                          class="chat-input"
                          rows="1"
                          placeholder="Message Salah Al-Din..."></textarea>

                <button class="clear-chat-mini" id="clear-chat-btn" title="Clear chat">
                    <i class="fas fa-trash"></i>
                </button>

                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
        else
        {
            <div class="input-group">
                <textarea class="chat-input" rows="1" disabled placeholder="Log in to send messages..."></textarea>
                <button class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", () => {

    const messagesArea = document.getElementById("messages-area");
    const sendButton = document.getElementById("send-button");
    const messageInput = document.getElementById("message-input");
    const clearChatBtn = document.getElementById("clear-chat-btn");
    const characterName = "Salah Al-Din";

    const initialSaladinMessage =
`By the mercy of Allah, I united the tribes, faced kings in iron, and held this city with an open hand... yet I tell you truly: the greatest test of patience is not the Frankish cavalry, but the logistics. One Emir begs for a sharper sword, another for a softer pillow. The man in charge of the camels argues with the man in charge of the water skins about who has the nobler profession. And the messenger pigeons? Half arrive bearing poetry from lovesick soldiers, the other half are eaten by someone's falcon. We are building a kingdom of heaven on earth, brick by brick, while herding cats with the pride of peacocks. Sometimes, I think Richard and I should have shared a cup of tea and simply agreed that managing men is like trying to write in the sand during a windstorm.`;

    function time(ts) {
        const d = new Date(ts);
        return `${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`;
    }

    function appendMessage(text, type, ts, id = null) {
        const bubble = document.createElement("div");
        bubble.className = `message-bubble ${type}-message`;
        if (id) bubble.dataset.messageId = id;

        bubble.innerHTML = `
            <p class="message-text">${text.replace(/\n/g, "<br>")}</p>
            <span class="message-time">${time(ts)}</span>
        `;
        messagesArea.appendChild(bubble);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    async function loadChatHistory() {
        if (!@SignInManager.IsSignedIn(User).ToString().ToLower()) return;

        const res = await fetch(`/Chat/GetChatHistory?characterName=${encodeURIComponent(characterName)}`);
        if (!res.ok) return;

        const history = await res.json();
        messagesArea.innerHTML = "";

        if (history.length === 0) {
            appendMessage(initialSaladinMessage, "bot", new Date());
            return;
        }

        history.forEach(m => {
            appendMessage(
                m.messageContent || m.MessageContent,
                m.isUser ? "user" : "bot",
                m.timestamp || m.Timestamp,
                m.id || m.Id
            );
        });
    }

    async function sendMessage() {
        const msg = messageInput.value.trim();
        if (!msg) return;

        appendMessage(msg, "user", new Date());
        messageInput.value = "";

        const loader = document.createElement("div");
        loader.className = "message-bubble bot-message";
        loader.innerHTML = `<p class="message-text"><span class="typing-indicator"><span></span><span></span><span></span></span></p>`;
        messagesArea.appendChild(loader);

        const res = await fetch("/Chat/SendMessage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ characterName, messageContent: msg })
        });

        loader.remove();

        if (res.ok) {
            const data = await res.json();
            appendMessage(data.reply, "bot", new Date());
        }
    }

    async function clearChat() {
        if (!confirm("Clear chat?")) return;

        await fetch(`/Chat/ClearChat?characterName=${encodeURIComponent(characterName)}`, {
            method: "DELETE"
        });

        messagesArea.innerHTML = "";
        appendMessage(initialSaladinMessage, "bot", new Date());
    }

    sendButton?.addEventListener("click", sendMessage);
    clearChatBtn?.addEventListener("click", clearChat);

    messageInput?.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    loadChatHistory();
});
</script>
}
